//@version=5
strategy("BTCUSDT Simple Webhook Strategy", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ==================== 파라미터 설정 ====================

// 이동평균선
fastLength = input.int(9, "Fast EMA", minval=1)
slowLength = input.int(21, "Slow EMA", minval=1)

// 레버리지 (실제 거래소에서 적용)
leverage = input.int(3, "Leverage", minval=1, maxval=125)

// Webhook 설정
account_id = input.string("your_account_id", "Account ID", tooltip="accounts-secure API에서 발급받은 계정 ID")
webhook_secret = input.string("your_webhook_secret", "Webhook Secret", tooltip=".env 파일의 WEBHOOK_SECRET")

// ==================== 지표 계산 ====================

fastEMA = ta.ema(close, fastLength)
slowEMA = ta.ema(close, slowLength)

// 매수/매도 시그널
longCondition = ta.crossover(fastEMA, slowEMA)
shortCondition = ta.crossunder(fastEMA, slowEMA)

// ==================== 차트 표시 ====================

plot(fastEMA, "Fast EMA", color=color.blue, linewidth=2)
plot(slowEMA, "Slow EMA", color=color.red, linewidth=2)

// 매수/매도 신호 표시
plotshape(longCondition, "Long", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortCondition, "Short", shape.triangledown, location.abovebar, color.red, size=size.small)

// ==================== Webhook 주문 ====================

// Binance Futures 롱 진입
if (longCondition and strategy.position_size == 0)
    strategy.entry("Long", strategy.long)
    alert('{"account_id":"' + account_id + '","exchange":"binance","action":"long","symbol":"BTCUSDT","leverage":' + str.tostring(leverage) + ',"secret":"' + webhook_secret + '","timestamp":' + str.tostring(timenow / 1000) + '}', alert.freq_once_per_bar_close)

// Binance Futures 숏 진입
if (shortCondition and strategy.position_size == 0)
    strategy.entry("Short", strategy.short)
    alert('{"account_id":"' + account_id + '","exchange":"binance","action":"short","symbol":"BTCUSDT","leverage":' + str.tostring(leverage) + ',"secret":"' + webhook_secret + '","timestamp":' + str.tostring(timenow / 1000) + '}', alert.freq_once_per_bar_close)

// 롱 포지션 청산 (반대 시그널)
if (shortCondition and strategy.position_size > 0)
    strategy.close("Long")
    alert('{"account_id":"' + account_id + '","exchange":"binance","action":"close_long","symbol":"BTCUSDT","secret":"' + webhook_secret + '","timestamp":' + str.tostring(timenow / 1000) + '}', alert.freq_once_per_bar_close)

// 숏 포지션 청산 (반대 시그널)
if (longCondition and strategy.position_size < 0)
    strategy.close("Short")
    alert('{"account_id":"' + account_id + '","exchange":"binance","action":"close_short","symbol":"BTCUSDT","secret":"' + webhook_secret + '","timestamp":' + str.tostring(timenow / 1000) + '}', alert.freq_once_per_bar_close)

// ==================== 설명 ====================

// 📌 사용 방법:
// 1. TradingView에서 Binance Futures: BTCUSDT 차트 열기
// 2. 이 스크립트 추가
// 3. account_id와 webhook_secret 입력
// 4. "알림 생성" → Webhook URL: http://your-backend-url/api/v1/webhook/tradingview
// 5. 알림 메시지에 {{strategy.order.alert_syntax}} 사용
//
// 📌 지원 거래소:
// - Binance Futures (BTCUSDT Perpetual)
// - OKX Futures (BTC-USDT-SWAP) - exchange를 "okx"로 변경
//
// 📌 레버리지:
// - 이 스크립트는 3배 레버리지 기본값
// - 실제 레버리지는 백엔드에서 설정됨
//
// 📌 주의사항:
// - 반드시 테스트넷에서 먼저 테스트!
// - Webhook URL은 HTTPS 권장
// - account_id는 로그인 후 계정 관리에서 확인
